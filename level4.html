<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Level 4: The Alchemist</title>
<!-- GLOBAL LOGIC -->
<script type="module" src="js/game-logic.js"></script>
<script type="module">
    import { checkGate } from './js/game-logic.js';
    // GATEKEEPING: Check for Level 3 Answer (ICEBERG)
    window.onload = () => { checkGate("ICEBERG"); }
</script>
<style>
  :root {
    --bg: #050505;
    --wood: #2d1b0e;
    --gold: #c5a059;
    --paper: #d8cba8;
  }
  body {
    margin: 0; height: 100vh;
    background-color: #000;
    font-family: 'Times New Roman', serif;
    overflow: hidden;
    cursor: default;
    user-select: none;
    display: flex; justify-content: center; align-items: center;
  }

  /* --- RESPONSIVE SCALER --- */
  #gameScale {
    width: 900px; height: 600px;
    position: relative; transform-origin: center;
    box-shadow: 0 0 50px rgba(0,0,0,0.5);
  }

  /* --- UI ELEMENTS (Fixed relative to body) --- */
  .timer {
    position: fixed; top: 20px; right: 20px;
    font-family: 'Courier New', monospace;
    font-size: 32px; font-weight: bold;
    color: #ff3333; text-shadow: 0 0 10px red;
    z-index: 200; pointer-events: none;
  }
  .timer-label { font-size: 12px; display: block; text-align: right; color: #888; text-shadow: none; }

  .held-item {
    position: fixed; pointer-events: none; z-index: 1000;
    font-size: 30px; transform: translate(-50%, -50%);
    text-shadow: 0 0 10px white; display: none;
  }

  .msg {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
    color: var(--gold); text-shadow: 0 0 5px gold; font-size: 14px;
    opacity: 0; transition: opacity 0.5s; background: rgba(0,0,0,0.8); padding: 5px 10px; z-index: 250;
    border: 1px solid var(--gold);
  }

  /* --- THE ROOM --- */
  .room {
    position: relative; width: 100%; height: 100%;
    background: #1a1a1a; overflow: hidden;
    border: 2px solid #333;
  }

  /* --- DECOR --- */
  .wall-texture {
    position: absolute; top:0; left:0; width:100%; height:100%;
    background: repeating-linear-gradient(90deg, #222 0px, #222 1px, transparent 1px, transparent 40px);
    opacity: 0.1;
  }
  .table {
    position: absolute; bottom: 0; width: 100%; height: 200px;
    background: linear-gradient(#2d1b0e, #1a0f05);
    border-top: 5px solid #3e2723;
  }

  /* --- OBJECTS --- */
  .parchment {
    position: absolute; top: 80px; left: 45%;
    width: 150px; height: 180px;
    background: var(--paper);
    box-shadow: 2px 5px 10px rgba(0,0,0,0.5);
    transform: rotate(3deg);
    padding: 15px; font-size: 11px; color: #420;
    font-family: 'Courier New', monospace;
    transition: transform 0.3s;
    cursor: help; z-index: 5; text-align: center;
  }
  .parchment::before { content: ''; position: absolute; top: 5px; left: 50%; width: 8px; height: 8px; background: #800; border-radius: 50%; }
  .parchment:hover { transform: scale(1.5) rotate(0deg); z-index: 50; }
  
  .rug {
    position: absolute; bottom: 50px; left: 15%; 
    width: 200px; height: 120px;
    background: radial-gradient(circle, #500, #200);
    border: 4px dashed #855; border-radius: 10px;
    transform: perspective(500px) rotateX(40deg);
    cursor: pointer; z-index: 10;
    transition: transform 0.6s ease-in-out;
    box-shadow: 0 10px 30px black;
  }
  .rug.moved { transform: perspective(500px) rotateX(40deg) translate(-150px, -50px) rotateZ(-20deg); opacity: 0.8; }

  .matches {
    position: absolute; bottom: 90px; left: 20%;
    width: 40px; height: 30px;
    background: #eee; border: 1px solid #999;
    z-index: 5; cursor: pointer;
    box-shadow: 2px 2px 5px black;
    display: flex; justify-content: center; align-items: center;
    font-size: 8px; color: #333; font-weight: bold;
  }
  .matches::after { content: "FIRE"; }

  .skull {
    position: absolute; top: 100px; right: 15%;
    width: 80px; height: 100px;
    background: #ccc; border-radius: 40px 40px 30px 30px;
    z-index: 10; cursor: pointer;
    box-shadow: inset -10px -10px 20px rgba(0,0,0,0.5);
    transition: transform 0.2s;
  }
  .skull-eyes { position: absolute; top: 40px; left: 15px; width: 20px; height: 25px; background: #222; border-radius: 50%; box-shadow: 30px 0 0 #222; }
  .skull-nose { position: absolute; top: 70px; left: 35px; width: 10px; height: 15px; background: #222; border-radius: 50%; }
  .skull.smashed { transform: rotate(90deg) translate(50px, 50px); }

  .lens {
    position: absolute; top: 130px; right: 17%;
    width: 30px; height: 30px;
    background: rgba(200, 255, 255, 0.4);
    border: 2px solid white; border-radius: 50%;
    z-index: 5; cursor: pointer;
    box-shadow: 0 0 10px white;
    animation: glint 3s infinite;
  }
  @keyframes glint { 0%,100% {opacity:0.6;} 50% {opacity:1;} }

  .candle-stand {
    position: absolute; bottom: 210px; left: 45%;
    width: 30px; height: 120px;
    background: #ddd;
    box-shadow: inset -5px 0 10px rgba(0,0,0,0.2);
    cursor: pointer; z-index: 20;
  }
  .wick { position: absolute; top: -10px; left: 13px; width: 4px; height: 10px; background: black; }
  .flame {
    position: absolute; top: -35px; left: 5px; width: 20px; height: 35px;
    background: radial-gradient(orange, red);
    border-radius: 50% 50% 20% 20%;
    filter: blur(2px); opacity: 0; transition: opacity 0.5s;
    animation: flicker 0.1s infinite;
  }
  @keyframes flicker { 0% {transform:scale(1);} 100% {transform:scale(1.1);} }

  .canvas-frame {
    position: absolute; top: 150px; left: 100px;
    width: 200px; height: 250px;
    border: 10px solid #2d1b0e;
    background: #eaddcf;
    box-shadow: 0 10px 40px black;
    display: flex; justify-content: center; align-items: center;
    overflow: hidden;
  }
  .secret-ink {
    font-size: 50px; font-weight: bold; color: #420;
    opacity: 0; transition: opacity 2s;
  }

  .telescope {
    position: absolute; top: 50px; right: 35%;
    width: 300px; height: 20px;
    background: var(--gold);
    transform: rotate(-15deg);
    cursor: pointer; z-index: 5;
  }
  .tripod {
    position: absolute; top: 100px; right: 40%;
    border-left: 10px solid transparent; border-right: 10px solid transparent;
    border-bottom: 200px solid #222; transform: rotate(-5deg);
  }

  .cryptex {
    position: absolute; bottom: 100px; right: 100px;
    width: 140px; height: 60px;
    background: radial-gradient(circle, var(--gold), #840);
    border-radius: 30px; border: 2px solid #420;
    display: flex; justify-content: center; align-items: center;
    cursor: pointer; z-index: 20;
    box-shadow: 0 5px 15px black;
  }
  .cryptex::after { content: "LOCKED"; font-size: 10px; font-weight: bold; letter-spacing: 2px; }

  /* --- MODALS --- */
  .modal-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.95); z-index: 300; display: none;
    justify-content: center; align-items: center; flex-direction: column;
  }
  .scope-circle {
    width: 300px; height: 300px; border-radius: 50%;
    background: #001; border: 4px solid var(--gold);
    position: relative; overflow: hidden;
  }
  .star { position: absolute; width: 4px; height: 4px; background: white; border-radius: 50%; opacity: 0; transition: 0.5s; }
  .target-star { top: 40%; left: 60%; width: 8px; height: 8px; box-shadow: 0 0 10px white; transition: 0.3s; }

</style>
</head>
<body onmousemove="handleMouseMove(event)">

<div class="timer">
  <span class="timer-label">TIME REMAINING</span>
  <span id="timerDisplay">00:45</span>
</div>

<div class="held-item" id="heldItem"></div>
<div class="msg" id="msgBox"></div>

<div id="gameScale">
    <div class="room">
      <div class="wall-texture"></div>

      <!-- CLUE -->
      <div class="parchment">
        <strong>THE ALCHEMIST'S LOG</strong>
        <div class="riddle-text" style="font-style:italic; border-top:1px solid #543; margin-top:20px; padding-top:10px;">
          "The <strong>Spark</strong> lies beneath the <strong>thread</strong>,<br>
          The <strong>Sight</strong> lies within the <strong>dead</strong>.<br>
          <strong>Illuminate</strong> the empty space,<br>
          To find the <strong>Hunter's</strong> hiding place."
        </div>
      </div>
      
      <!-- ITEMS -->
      <div class="rug" id="rug" onclick="moveRug()"></div>
      <div class="matches" id="matches" onclick="pickUp('matches')"></div>

      <div class="shelf" style="position:absolute; top:50px; right:100px; width:300px; height:10px; background:var(--wood);"></div>
      <div class="skull" id="skull" onclick="smashSkull()">
        <div class="skull-eyes"></div>
        <div class="skull-nose"></div>
      </div>
      <div class="lens" id="lens" onclick="pickUp('lens')"></div>

      <div class="canvas-frame" id="canvas">
        <div class="secret-ink" id="secretInk">ORION</div>
      </div>

      <div class="candle-stand" id="candle" onclick="interactCandle()">
        <div class="wick"></div>
        <div class="flame" id="flame"></div>
      </div>
      
      <div class="table"></div>
      <div class="ink-pot" style="position:absolute; bottom:200px; left:400px; width:30px; height:30px; background:#000; border-radius:50%;"></div>
      <div class="quill" style="position:absolute; bottom:220px; left:410px; width:5px; height:80px; background:white; transform:rotate(20deg);"></div>

      <div class="telescope" onclick="useScope()"></div>
      <div class="tripod"></div>

      <div class="cryptex" onclick="openCryptex()"></div>

      <!-- SCOPE MODAL (INSIDE SCALE) -->
      <div class="modal-overlay" id="scopeModal">
        <div class="scope-circle">
            <div class="star" style="top:20%; left:30%"></div>
            <div class="star" style="top:70%; left:20%"></div>
            <div class="star" style="top:80%; left:80%"></div>
            <div class="star target-star" id="targetStar"></div>
        </div>
        <h2 style="color:white; margin-top:20px;">AZIMUTH DIAL</h2>
        <input type="range" min="0" max="100" value="0" style="width:300px;" oninput="adjustDial(this.value)">
        <p style="color:#888;">Set to the angle of the Belt...</p>
        <button onclick="document.getElementById('scopeModal').style.display='none'" style="margin-top:20px; padding:10px; cursor:pointer;">BACK</button>
      </div>
    </div>
</div>

<script>
  // --- RESPONSIVE SCALER ---
  function resizeGame() {
    const game = document.getElementById('gameScale');
    const width = window.innerWidth;
    const height = window.innerHeight;
    const scale = Math.min(width / 900, height / 600); 
    game.style.transform = `scale(${scale})`;
  }
  window.addEventListener('resize', resizeGame);
  resizeGame();

  // --- TIMER LOGIC ---
  let timeLeft = 45;
  const timerDisplay = document.getElementById('timerDisplay');
  const timerInterval = setInterval(() => {
    timeLeft--;
    timerDisplay.innerText = `00:${timeLeft < 10 ? '0'+timeLeft : timeLeft}`;
    if (timeLeft <= 5) timerDisplay.style.color = "red";
    
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      alert("TIME EXPIRED. The alchemist returns...");
      location.reload(); // Restart Level
    }
  }, 1000);

  // --- GAME STATE ---
  const state = {
    holding: null,
    rugMoved: false,
    skullSmashed: false,
    hasMatches: false,
    hasLens: false,
    candleLit: false,
    lensInstalled: false,
    scopeSolved: false
  };

  const heldItem = document.getElementById('heldItem');

  function showMsg(text) {
    const box = document.getElementById('msgBox');
    box.innerText = text;
    box.style.opacity = 1;
    setTimeout(() => box.style.opacity = 0, 2500);
  }

  // MOUSE FOLLOWER
  function handleMouseMove(e) {
    heldItem.style.top = (e.clientY + 20) + 'px';
    heldItem.style.left = (e.clientX + 20) + 'px';

    // Reveal Logic (Candle + Canvas)
    if (state.holding === 'candle') {
        const canvas = document.getElementById('canvas').getBoundingClientRect();
        if (e.clientX > canvas.left && e.clientX < canvas.right && 
            e.clientY > canvas.top && e.clientY < canvas.bottom) {
            document.getElementById('secretInk').style.opacity = 1;
        } else {
            document.getElementById('secretInk').style.opacity = 0;
        }
    }
  }

  // 1. RUG
  function moveRug() {
    if(!state.rugMoved) {
        document.getElementById('rug').classList.add('moved');
        document.getElementById('matches').style.display = 'block';
        state.rugMoved = true;
    }
  }

  // 2. SKULL
  function smashSkull() {
    if(!state.skullSmashed) {
        document.getElementById('skull').classList.add('smashed');
        document.getElementById('lens').style.display = 'block';
        state.skullSmashed = true;
    }
  }

  // 3. PICK UP ITEM
  function pickUp(item) {
    if (item === 'matches') {
        state.holding = 'matches';
        heldItem.innerText = "ðŸ”¥";
        heldItem.style.display = 'block';
        document.getElementById('matches').style.display = 'none';
        state.hasMatches = true;
        showMsg("Matches acquired.");
    }
    if (item === 'lens') {
        state.holding = 'lens';
        heldItem.innerText = "ðŸ”";
        heldItem.style.display = 'block';
        document.getElementById('lens').style.display = 'none';
        state.hasLens = true;
        showMsg("Lens acquired.");
    }
  }

  // 4. CANDLE INTERACTION
  function interactCandle() {
    // Light it
    if (state.holding === 'matches' && !state.candleLit) {
        document.getElementById('flame').style.opacity = 1;
        state.candleLit = true;
        state.holding = null; // drop matches
        heldItem.style.display = 'none';
        showMsg("Candle lit.");
        return;
    }
    
    // Pick up / Put down Lit Candle
    if (state.candleLit) {
        if (state.holding === 'candle') {
            state.holding = null; // Put down
            heldItem.style.display = 'none';
            document.getElementById('candle').style.opacity = 1;
        } else {
            state.holding = 'candle'; // Pick up
            heldItem.innerText = "ðŸ•¯ï¸";
            heldItem.style.display = 'block';
            document.getElementById('candle').style.opacity = 0.5;
            showMsg("Carrying Candle.");
        }
    } else {
        showMsg("It's dark. You need fire.");
    }
  }

  // 5. TELESCOPE
  function useScope() {
    if (state.holding === 'lens') {
        state.lensInstalled = true;
        state.holding = null;
        heldItem.style.display = 'none';
        showMsg("Lens installed.");
        return;
    }
    if (!state.lensInstalled) {
        showMsg("It's blurry. Missing a part.");
        return;
    }
    // Open Modal
    document.getElementById('scopeModal').style.display = 'flex';
    document.getElementById('targetStar').style.opacity = 0; // Hidden until tuned
  }

  function adjustDial(val) {
    // Reveal stars
    const stars = document.querySelectorAll('.star');
    stars.forEach(s => s.style.opacity = 0.2); // Faint

    if (val == 33) {
        document.getElementById('targetStar').style.backgroundColor = "#00ff41"; // Green
        document.getElementById('targetStar').style.boxShadow = "0 0 20px #00ff41";
        stars.forEach(s => s.style.opacity = 1);
        state.scopeSolved = true;
    } else {
        document.getElementById('targetStar').style.backgroundColor = "white";
        document.getElementById('targetStar').style.boxShadow = "none";
    }
  }

  // 6. CRYPTEX
  function openCryptex() {
    if(!state.scopeSolved) {
        showMsg("Locked.");
        return;
    }
    const input = prompt("Enter the color of the star:");
    if (input && input.toUpperCase() === "GREEN") {
        clearInterval(timerInterval); // Stop Timer
        alert("LEVEL COMPLETE!\nCode: ORION-GREEN.\n\nProceeding to Final Level...");
        window.location.href = "level5.html";
    } else {
        alert("Wrong.");
    }
  }

</script>
</body>
</html>